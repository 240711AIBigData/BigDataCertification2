# CHAPTER03 카이제곱 검정
- 카이제곱 검정(Chi-square test)

  - 통계학에서 범주형 데이터의 관찰된 빈도와 기대된 빈도를 비교
 
  - 두 변수 간의 독립성이나 분포의 적합성 검정 방법
 
    - 적합도 검정
   
    - 독립성 검정
   
    - 동질성 검정
   
<br>

SERCTION01 적합도 검정(Goodness of fit test)
---
- 1개의 범주형 변수가 특정 분포를 잘 따르고 있는지 검정하는 데 사용

  - **귀무가설** : 특정 분포를 따른다 (특정 분포 확률을 따른다)
 
  - **대립가설** : 특정 분포를 따르지 않는다 (특정 분포 확률을 따르지 않는다)

<br>

### 01. 카이제곱 적합도 검정
```python
  scipy.stats.chisquared(observed, expected, ddof, axis)
```
- observed : 관측된 빈도 리스트(배열)

- expected : 기대 빈도 리스트(배열)

  - 주어지지 않으면 모든 카테고리의 관측 빈도가 균일하고 관측 민도의 평균으로 주어진다고 가정
 
- ddof : 자유도 조정, 기본값 0

- axis : 축, 기본값 0

<br>

#### ✏️ 문제
> 어떤 도시에서 300명을 대상으로 아이스크림 맛 선호도를 조사했다.<br>
> 이 도시에서 조사된 맛 선호도는 바닐라:150명, 초코:120명, 딸기:30명이었다.<br>
> 전국적인 아이스크림 맛 선호도 조사 결과를 통해 알려진 비율은 각 50%, 35%, 15% 이다. (유의수준 0.05) <br>
> 이 도시의 아이스크림 맛 선호도는 전국적인 맛 선호도와 차이가 있는가?

- 귀무가설(H₀) : 이 도시의 아이스크림 맛 선호도는 전국적인 선호도와 동일하다

- 대립가설(H₁) : 이 도시의 아이스크림 맛 선호도는 전국적인 선호도와 다르다

<br>

> 코드
```python
  from scipy import stats
  
  observed = [150, 120, 30]
  expected = [0.5*300, 0.35*300, 0.15*300]
  print(stats.chisquare(observed, expected))
```
- 카이제곱 검정 수행시 올바른 결과를 얻기 위해서는 관측된 빈도와 기대 빈도 사용

  - 한쪽이 빈도로 주어지고 다른 한쪽이 비율로 주어진다면?
 
    - 검정 수행 전 두 데이터를 동일한 형식(빈도)로 통일
   
- 적합도 검정은 chisquare() 함수 사용해 검정 통계량과 p-value 구함

> 결과
```python
  Power_divergenceResult(statistic=7.142857142857142, pvalue=0.028115659748972056)
```
- 검정 통계량 : 7.14

- 0.028(p-value) < 0.05(유의수준) : 귀무가설 기각, 대립가설 채택

  - 이 도시의 아이스크림 맛 선호도는 전국적인 맛 선호도와 다르다

<br>

#### 💡 기대값을 빈도가 아닌 비율로 입력해도 괜찮을까?
- 기대값은 비율이 아니라 빈도로 입력해야 함

- scipy.stats.chisquare(f_obs, f_exp) 함수의 매개변수 f_obs와 f_exp는 동일한 단위를 가져야 함

  - f_obs : 관측된 빈도수 (예: 카테고리별 샘플 수)
  
  - f_exp : 기대되는 빈도수, f_obs와 동일한 총합을 가져야 함

  - 비율([0.5, 0.35, 0.15])일 때와 빈도([0.5*300, 0.35*300, 0.15*300])일 때 다른 결과가 나옴

    - 비율(확률 분포) 입력시, f_obs와 f_exp의 스케일이 달라져 카이제곱 통계량을 계산할 수 없어 오류 발생

<br>

---

<Br>

SECTION02 독립성 검정(Test of independence)
---
- 2개의 변수가 서로 독립적인지, 연관이 있는지 검정하는 데 사용

  - 귀무가설(H₀) : 두 범주형 변수가 독립적이다(서로 연관성이 없다)
 
  - 대립가설(H₁) : 두 범주형 변수가 독립적이 아니다(서로 연관성이 있다)

<br>

### 01. 교차표 기반 카이제곱 검정
```python
  scipy.stats.chi2_contingency(table, correction=Ture)
```
- table : 교차표(Contingency) 데이터(2차원 형태)

- correction : 연속성 보정 여부, 기본값은 True

  - 연속성 수정을 적용한 것과 적용하지 않았을 때의 통계량은 다름
 
    - 문제에서 연속성 수정에 대한 언급이 없다면 기본값(True)
   
    - '연속성 수정을 하지 않는다'라는 조건이 있다면 False
   
- 귀무가설이 참일 때 구한 각 셀의 기대 빈도와 실제 관측된 빈도의 차이를 사용해 검정

  - 기대 빈도와 관측된 빈도 차이가 크면 독립적이지 않고, 차이가 작으면 독립적

<br>

### ✏️ 문제
> 성별에 따라 운동을 좋아하는지 조사한 결과다.<br>
> 성별과 운동 선호도가 독립적인지 가설검정을 실시하시오. (유의수준 0.05) <br>

- 귀무가설(H₀) : 성별과 운동 선호도는 독립적이다

- 대립가설(H₁) : 성별과 운동 선호도는 독립적이지 않다

- 이 문제에서 주어질 데이터는 교차표 데이터가 주어졌을 때와 로우(raw) 데이터가 주어졌을 때 두 가지 상황 있을 수 있음

<br>

#### 💡 독립의 의미
- 변수 간의 독립을 의미

  - 남자와 여자는 독립적이다. 따라서 운동 선호도가 다르다. (X)
 
  - 두 변수인 성별과 운동 선호도가 독립적이다 (O)
 
    - 성별 간의 운동 선호도 차이는 없다
   
- 대립가설의 '서로 독립적이 아니다' 는 영향을 미친다는 것으로 해석

  - 성별에 따라 운동 선호도가 달라진다

<br>

#### [풀이1] 교차표 데이터가 주어졌을 때
- 교차(분할) 데이터가 제시된다면 다음 내용을 교차표 데이터로 생성

  - 남자 : 좋아함 80명, 좋아하지 않음 30명
 
  - 여자 : 좋아함 90명, 좋아하지 않음 10명
 
<br>

**(1) 교차표 만들기**
- 주어진 내용으로 교차표를 데이터프레임으로 생성

| |좋아함|좋아하지 않음|
|:-:|:-:|:-:|
|남자|80|30|
|여자|90|10|

<br>

> [방법1] 데이터프레임 만들기 : 컬럼(열) 방향
```python
  import pandas as pd
  df = pd.DataFrame({
      '좋아함' : [80, 90],
      '좋아하지 않음' : [30, 10]},
                  index=['남자', '여자']
  )
  print(df)
```

> 결과
```python
      좋아함  좋아하지 않음
  남자   80       30
  여자   90       10
```

<br>

> [방법2] 데이터프레임 만들기 : 행 방향
```python
  df = pd.DataFrame([[80, 30], [90, 10]],
                    columns=['좋아함', '좋아하지 않음'],
                    index=['남자', '여자'])
  print(df)
```
- 인덱스명과 컬럼명은 있으면 좋지만, 없어도 상관X

> 결과
```python
      좋아함  좋아하지 않음
  남자   80       30
  여자   90       10
```

<br>

> [방법3] 리스트 만들기
```python
  df = pd.DataFrame([80, 30], [90,10])
  print(df)
```

> 결과
```python
       0
  90  80
  10  30
```

<br>

**(2) 독립성 검정**
- chi2_contingency() 함수 사용하여 카이제곱 통계량과 p-value 구하기

> 코드
```python
  from scipy.stats import chi2_contingency
  print(chi2_contingency(df))
```

> 결과
```python
  Chi2ContingencyResult(statistic=9.045792112299468, pvalue=0.0026330012530379632, dof=1, expected_freq=array([[89.04761905, 20.95238095],
         [80.95238095, 19.04761905]]))
```
- 검정통계량 : 9.04

- 0.002(p-value) < 0.05(유의수준) : 귀무가설 기각, 대립가설 채택

  - 성별과 좋아함 여부는 독립적이지 않다
 
- expected_freq(기대 빈도수) : 관찰된 데이터가 독립적일 경우 예상되는 빈도수

  - 89.04761905 : 남자가 좋아함을 선택할 것으로 기대되는 수
 
  - 20.95238095 : 남자가 좋아하지 않음을 선택할 것으로 기대되는 수
 
  - 80.95238095 : 여자가 좋아함을 선택할 것으로 기대되는 수
 
  - 19.04761905 : 여자가 좋아하지 않음을 선택할 것으로 기대되는 수

<br>

#### 💡 시험 환경에서의 chi2_contingency() 함수 결과
- chi2_contingency() 함수는 독립성 검사와 동질성 검사에서 활용하는 함수

- 반환 결과가 버전에 따라 코랩에서는 statistic, dof, expected_freq 로 표기

- 시험 환경에서는 값(statistic, p-value) 만 표기

<br>

#### [풀이2] 로우(raw) 데이터가 주어졌을 때
- 문제에서 로우(원) 데이터 형태로 주어졌다고 가정

  - 210개의 행 (남자 110명, 여자 100명)

<div>
  <table>
      <tbody>
          <tr>
            <td>성별</td>
            <td>운동</td>
          </tr>
          <tr>
              <td rowspan="2">남자<br>(110명)</td>
              <td>좋아함(80명)</td>
          </tr>
          <tr>
              <td>좋아하지 않음(30명)</td>
          </tr>
          <tr>
              <td rowspan="2">여자<br>(100명)</td>
              <td>좋아함(90명)</td>
          </tr>
          <tr>
              <td>좋아하지 않음(10명)</td>
          </tr>
      </tbody>
  </table>
</div>

<br>

> 실습용 데이터 생성
```python
  import pandas as pd
  data = {
      '성별' : ['남자'] * 110 + ['여자'] * 100,
      '운동' : ['좋아함'] * 80 + ['좋아하지 않음'] * 30 + ['좋아함'] * 90 + ['좋아하지 않음'] * 10
  }
  df = pd.DataFrame(data)
  print(df.head(3))
```
- 시험에서는 csv 파일 형태로 제공됨

> 결과
```python
     성별   운동
  0  남자  좋아함
  1  남자  좋아함
  2  남자  좋아함
```

<br>

**(1) 크로스탭을 활용해 교차표로 변경**
- 로우 데이터를 pd.crosstab() 함수를 활용해 교차표로 변경

  - 교차표 : 주로 변수 간의 관게를 비교할 때 사용
 
> 코드
```python
  df = pd.crosstab(df['성별'], df['운동'])
  df
```

> 결과
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>운동</th>
      <th>좋아하지 않음</th>
      <th>좋아함</th>
    </tr>
    <tr>
      <th>성별</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>남자</th>
      <td>30</td>
      <td>80</td>
    </tr>
    <tr>
      <th>여자</th>
      <td>10</td>
      <td>90</td>
    </tr>
  </tbody>
</table>
</div>

- 앞에서 직접 만든 교차표와 순서는 다르지만, 같은 형태로 변경됨

<br>

**(2) 독립성 검정**
- chi2_contingency() 함수 사용하여 카이제곱 통계량과 p-value 구하기

> 코드
```python
  from scipy.stats import chi2_contingency
  print(chi2_contingency(df))
```

> 결과
```python
  Chi2ContingencyResult(statistic=9.045792112299468, pvalue=0.0026330012530379632, dof=1, expected_freq=array([[20.95238095, 89.04761905],
         [19.04761905, 80.95238095]]))
```
- 교차표 데이터를 만들어 진행한 것과 같음

  - 검정 통계량 : 9.04
 
  - 0.002(p-value) < 0.05(유의수준) : 귀무가설 기각, 대립가설 채택
 
    - 성별과 좋아함 여부는 독립적이지 않다
   
- 기대 빈도 해석(expected_freq)

  - 20.95238095 : 남자가 좋아하지 않음을 선택할 것으로 기대되는 수
 
  - 89.04761905 : 남자가 좋아함을 선택할 것으로 기대되는 수
 
  - 19.04761905 : 여자가 좋아하지 않음을 선택할 것으로 기대되는 수
 
  - 80.95238095 : 여자가 좋아함을 선택할 것으로 기대되는 수

<br>

#### 💡 사이파이에서 scipy 모듈 또는 함수를 가져오는 방법
- 사이파이뿐만 아니라 파이썬 라이브러리를 사용할 때 공통된 부분

> 방법1
```python
  # stats 모듈 전체를 불러와 필요한 함수 사용
  from scipy import stats
  stats.chi2_contingency(df)
```

> 방법2
```python
  # scipy.stats 모듈에서 chi2_contingency() 함수만 가져와서 사용
  from scipy.stats import chi2_contingency
  chi2_contingency(df)
```

<br>

---

<br>

SECTION03 동질성 검정(Test of homogeneity)
---
- 2개 이상의 집단에서 분산의 동질성을 가졌는지 검정하는 데 사용

- 동질성 검정은 목적과 적용 상황은 다르지만, 계산 방식 동일 (해석만 다름)

- 범주형 데이터 분석에서 p-value, 통계량, 귀무가설 채택 및 기각 등이 문제로 출제시

  - 답 작성할 때 독립성과 동질성 문제를 하나로 생각
 
    - 귀무가설 : 모든 그룹의 분포나 비율은 동일하다
   
    - 대립가설 : 각 그룹의 분포나 비율은 동일하지 않다

<br>

### 01. 교차표 기반 카이제곱 검정
```python
  scipy.stats.chi2_contingency(table, correction=True)
```
- table : 교차표(Contingency Table) 데이터(2차원 형태)

- correction : 연속성 보정 여부, 기본값은 True

  - 연속성 수정을 적용한 것과 적용하지 않았을 때의 통계량은 다름
 
    - 문제에서 연속성 수정에 대한 언급이 없다면 기본값(True)
   
    - '연속성 수정을 하지 않는다' 라는 조건이 있다면 False

<br>

### 02. 독립성 검정과 동질성 검정
- 독립성 검정 : 두 범주형 변수 간에 연관성이 있는지 확인

  - ex) 성별이 운동 선호도에 영향을 주는가?
 
- 동질성 검정 : 서로 다른 그룹 또는 모집단이 동일한 범주 분포를 가졌는지 확인

  - ex) 2개의 다른 학교에서 학생들의 운동 선호도가 동일한가?
 
<br>

#### ✏️ 문제
> 학과에 따라 학교 공식 동아리에 가입한 학생의 수와 가입하지 않은 학생의 수를 비교하는 동질성 검사 실시하고,<br>
> 유의수준에 따른 검정 결과를 작성하시오. (유의수준 0.05)

- 귀무가설(H₀) : 두 학과의 동아리 가입 비율은 동일하다

- 대립가설(H₁) : 두 학과의 동아리 가입 비율은 동일하지 않다

<br> 

### 03. 교차표 데이터가 주어졌을 때

|학과|가입|미가입|
|:-:|:-:|:-:|
|통계학과|50|50|
|컴퓨터공학과|30|70|

> 코드
```python
  import pandas as pd
  from scipy import stats
  df = pd.DataFrame([[50, 50], [30, 70]])  # 데이터 생성
  print(stats.chi2_contingency(df))
```
- chi2_contingency() 함수를 사용해 검정 통계량, p-value 구하기

> 결과
```python
  Chi2ContingencyResult(statistic=7.520833333333334, pvalue=0.006098945931214352, dof=1, expected_freq=array([[40., 60.],
         [40., 60.]]))
```
- 검정통계량 : 7.52

- 0.006(p-value) < 0.05(유의수준) : 귀무가설 기각, 대립가설 채택

  - 두 학과의 동아리 가입 비율은 동일하지 않다

<br>

### 04. 로우(raw) 데이터가 주어졌을 때
> 로우 데이터 임의 생성
```python
  import pandas as pd
  data = {
      '학과' : ['통계학과'] * 100 + ['컴퓨터공학과'] * 100,
      '동아리가입여부' : ['가입'] * 50 + ['미가입'] * 50 + ['가입'] * 30 + ['미가입'] * 70
  }
  df = pd.DataFrame(data)
  print(df.sample(5))     # 샘플 5개 임의 출력 -> 매 실행 때마다 다른 결과 출력
```

> 결과
```python
           학과 동아리가입여부
  156  컴퓨터공학과     미가입
  132  컴퓨터공학과     미가입
  69     통계학과     미가입
  55     통계학과     미가입
  159  컴퓨터공학과     미가입
```

<br>

> 코드
```python
  df = pd.crosstab(df['학과'], df['동아리가입여부'])
  df
```
- 로우 데이터를 pd.crosstab() 함수를 활용해 교차표로 변경

  - 교차표는 주로 변수 간의 관계를 비교할 때 사용

> 결과
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>동아리가입여부</th>
      <th>가입</th>
      <th>미가입</th>
    </tr>
    <tr>
      <th>학과</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>컴퓨터공학과</th>
      <td>30</td>
      <td>70</td>
    </tr>
    <tr>
      <th>통계학과</th>
      <td>50</td>
      <td>50</td>
    </tr>
  </tbody>
</table>
</div>

<br>

- 앞서 직접 만든 교차표와 순서는 다르지만, 같은 형태로 변경됨

<br>

> 코드
```python
  from scipy import stats
  print(stats.chi2_contingency(df))
```
- chi2_contingency() 함수를 사용해 검정 통계량, p-value 구하기

> 결과
```python
  Chi2ContingencyResult(statistic=7.520833333333334, pvalue=0.006098945931214352, dof=1, expected_freq=array([[40., 60.],
         [40., 60.]]))
```
- 검정통계량 : 7.52

- 0.006(p-value) < 0.05(유의수준) : 귀무가설 기각, 대립가설 채택

  - 두 학과의 동아리 가입 비율은 동일하지 않다

- 기대 빈도 해석(expected_freq)

  - 교차표를 보고 기대 빈도를 순소대로 해석하는 것이 중요
 
  - 교차표를 순서대로 좌에서 우로, 위에서 아래로 읽으면서 기대 빈도도 순서대로 매칭해 해석
 
    - 40.0 : 컴퓨터공학과 학생이 동아리에 가입할 것으로 기대되는 수
   
    - 60.0 : 컴퓨터공학과 학생이 동아리에 미가입할 것으로 기대되는 수
   
    - 40.0 : 통계학과 학생이 동아리에 가입할 것으로 기대되는 수
   
    - 60.0 : 통계학과 학생이 동아리에 미가입할 것으로 기대되는 수

<br>

