# CHAPTER02 분산 분석
- 분산 분석(ANOVA, 아노바) : 여러 집단의 평균 차이를 통계적으로 유의미한지 검정하는 방법

  - 주로 3개 이상의 집단을 비교할 때 사용
 
    - 일원 분산 분석 : 단일 요인의 수준 간 평균의 차이 검정
   
    - 이원 분산 분석 : 두 요인의 수준 간 및 그들의 상호작용이 평균에 미치는 영향 검정
   
- 요인(factor) : 독립변수

  - 머신러닝에서는 '피처' 또는 '변수'
 
  - 통계학에서는 '요인' 또는 '독립변수'

<br>

SECTION01 일원 분산 분석(One-way ANOVA)
---
- 3개 이상의 집단 간의 평균 차이가 통계적으로 유의한지 검정하는 방법

  - 집단을 나누는 요인이 하나고 집단의 수가 3개 이상일 때 사용
 
    - 집단을 나누는 요인이 하나고 집단의 수가 2개일 때는 t-검정 실시

<br>

### 01. 기본 가정
- 분산 분석의 기존 가정은 독립 표본 t-검정과 유사

  - 독립성, 정규성, 등분산성을 기본 가정으로 함
 
    - **독립성** : 각 집단의 관측치들은 모두 다르 집단의 관측치들과 독립적(기본 가정)
   
    - **정규성** : 각 집단에서의 관측치는 정규 분포를 따름(Shapiro-Wilk test)
   
    - **등분산성** : 모든 집단에서의 관측치는 동일한 분산을 가짐(Levene test)

<br>

### 02. 귀무가설과 대립가설
- 귀무가설(H₀) : 모든 집단의 평균은 동일하다

- 대립가설(H₁) : 집단의 평균에는 차이가 있다

  - 모두 같다고 할 수 없지만 적어도 두 그룹 간의 평균에는 차이가 있다

<br>

### 03. 일원 분산 분석
- 사이파이의 f_oneway 사용

> 코드
```python
  scipy.stats.f_oneway(sample1, sample2, sample3, ...)
```
- sample1 : 첫 번째 집단 데이터
  
- sample2 : 두 번째 집단 데이터

- sample3 : 세 번째 집단 데이터

<br>

#### ✏️ 문제
> 주어진 데이터는 4종류의 비료를 사용한 식물의 성장에 대한 실험 결과이다.<br>
> 이 실험에서는 비슷한 조건의 식물 40개를 무작위로 10개씩 나누고 화학비료 A, B, C, D 를 일정 기간 사용 후 <br>
> 성장량을 측정했다. 성장의 차이가 있는지 유의수준 0.05 하에서 검정하시오.<br>

- 귀무가설(H₀) : 네 가지 비료의 효과는 동일하다

- 대립가설(H₁) : 비료의 효과에는 차이가 있다(적어도 두 가지 비료의 효과에는 차이가 있다)

> 코드
```python
  import pandas as pd
  df = pd.DataFrame({
      'A' : [10.5, 11.3, 10.8, 9.6, 11.1, 10.2, 10.9, 11.4, 10.5, 10.3],
      'B' : [11.9, 12.4, 12.1, 13.2, 12.5, 11.8, 12.2, 12.9, 12.4, 12.3],
      'C' : [11.2, 11.7, 11.6, 10.9, 11.3, 11.1, 10.8, 11.5, 11.4, 11.0],
      'D' : [9.8, 9.4, 9.1, 9.5, 9.6, 9.9, 9.2, 9.7, 9.3, 9.4]
  })
  print(df.head(2))
```

> 결과
```python
        A     B     C    D
  0  10.5  11.9  11.2  9.8
  1  11.3  12.4  11.7  9.4
```

<br>

> 코드
```python
  from scipy import stats
  
  print('==== 정규성 검정 ====')
  print(stats.shapiro(df['A']))
  print(stats.shapiro(df['B']))
  print(stats.shapiro(df['C']))
  print(stats.shapiro(df['D']))
  
  print('\n==== 등분산성 검정 ====')
  print(stats.levene(df['A'], df['B'], df['C'], df['D']))
  
  print('\n==== 일원 분산 분석 ====')
  print(stats.f_oneway(df['A'], df['B'], df['C'], df['D']))
```

> 결과
```python
  ==== 정규성 검정 ====
  ShapiroResult(statistic=0.9649054066073813, pvalue=0.8400161543468654)
  ShapiroResult(statistic=0.9468040874196029, pvalue=0.6308700692815115)
  ShapiroResult(statistic=0.9701646110856055, pvalue=0.892367306190296)
  ShapiroResult(statistic=0.9752339025839644, pvalue=0.9346854448707653)
  
  ==== 등분산성 검정 ====
  LeveneResult(statistic=1.9355354288758708, pvalue=0.14127835331346628)
  
  ==== 일원 분산 분석 ====
  F_onewayResult(statistic=89.12613851177174, pvalue=1.001838152252373e-16)
```
- 정규성 검정(Shapiro-Wilk test)

  - A, B, C, D 의 모든 그룹에 대한 p-value > 0.05
 
    - 모든 그룹의 데이터가 정규 분포를 따름
   
- 등분산성 검정(Levene test)

  - p-value > 0.05
 
    - 모든 그룹의 분산이 동일
   
  - 레빈 검정은 center=mean 과 center=median 존재
 
    - mean : Levene(레빈) 검정
   
    - median : Brown-Forsythe(브라운 포사이드) 검정
   
- 일원 분산 분석(One-way ANOVA)

  - p-value < 0.05
 
    - 적어도 두 그룹 간의 평균 성장량에는 차이가 있다고 볼 수 있음

    - 모든 비료의 효과가 동일하다는 귀무가설 기각, 대립가설 채택
      
<br>

### 04. 일원 분산 분석(ols 활용)
- 일원 분산 분석 방법

  - 사이파이(scipy)의 f_oneway
 
  - 스태츠모델즈(statsmodels)의 ols.anova_lm
 
    - 제공된 데이터가 ols 입력 데이터로 적합하지 않은 경우 변경
   
      - 데이터 전처리는 주어진 데이터에 따라 작업할 뿐 분산분석의 필수 내용은 아님

> 코드
```pyrhon
  import pandas as pd
  df = pd.read_csv('./data/fertilizer.csv')
  df.head()
```

> 결과

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>비료</th>
      <th>성장</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>A</td>
      <td>10.5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>A</td>
      <td>11.3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>A</td>
      <td>10.8</td>
    </tr>
    <tr>
      <th>3</th>
      <td>A</td>
      <td>9.6</td>
    </tr>
    <tr>
      <th>4</th>
      <td>A</td>
      <td>11.1</td>
    </tr>
  </tbody>
</table>
</div>

<br>

- ols 와 anova_lm 사용해 선형 모델 학습 및 결과 출력

  - ols() 함수는 R 스타일의 표현식(formula) 사용
 
|구분|설명|
|:-:|-|
|물결(~)|종속변수와 독립변수를 구분하는 기호<br>ex) target ~ a 에서 target 은 종속변수, a 는 독립변수|
|더하기(+)|여러 독립변수들을 모델에 포함하기 위한 기호<br>ex) target ~ a + b + c + d 는 a, b, c, d 독립변수를 모두 포함하겠다는 의미|

<br>

> 코드
```python
  from statsmodels.formula.api import ols
  from statsmodels.stats.anova import anova_lm
  model = ols('성장 ~ C(비료)', df).fit()
  print(anova_lm(model))
```

> 결과
```python
              df    sum_sq    mean_sq          F        PR(>F)
  C(비료)      3.0  43.21875  14.406250  89.126139  1.001838e-16
  Residual  36.0   5.81900   0.161639        NaN           NaN
```
- 사이파이(scipy)의 f_oneway 의 F-통계량과 p-value 동일

- C() 사용하면 이 변수가 범주형 변수임을 명시

  - variable 변수는 문자이기에 자동 원핫인코딩 처리하므로 C() 가 없더라도 결과는 같음

<br>

|구분|설명|
|:-:|-|
|df<br>(자유도, degree of freedom)|전체 데이터(관찰) 수 : 4 * 10 = 40<br>전체 데이터(관찰) 수의 자유도 : 40 - 1 = 39<br>그룹(처리 조건)의 자유도 : 4 - 1 = 3<br>잔차의 자유도 : 39 - 3 = 36|
|sum_sq<br>(제곱합, SS)|그룹(처리 조건)별 또는 잔차별 제곱합(sum of squares)|
|mean_sq<br>(평균 제곱, MS)|평균 제곱합(mean of sum of squares)으로 sum_sq 를 df 로 나눈 값|
|F(F-통계량)|F-통계량|
|PR(>F)(p-값)|F-통계량에 대한 p-value|

<br>

---

<br>

SECTION02 이원 분산 분석
---
- 이원 분산 분석(Two-way ANOVA) : 요인의 수가 2개인 경우

  - ex) 빅분기 실기 시험 학습 방법과 학습 장소에 따른 성적 분석
 
    - A 요인 : 학습 방법인 도서와 강의
   
    - B 요인 : 학습 장소인 집과 카페

<br>

|A 요인 : 학습 방법|도서|도서|강의|강의|
|-|-|-|-|-|
|B 요인 : 학습 장소|집|카페|집|카페|

<br>

<details>
  <summary>💡 인원 분산 분석 2번 대신 이원 분산 분석 하는 이유</summary>

- 1종 오류가 커짐

  - 독립 표본 t-검정을 반복하지 않고 일원 분산 분석 하는 것과 같음
  
  - 연구 질문이 하나면 한번에 통계적 검정으로 실시하는 것이 1종의 오류 통제 가능

- 각 요인의 메인 효과와 상호작용 요인 검정 가능

  - 일원 분산 분석으로는 상호작용 효과 알 수 없음

</details>

<br>

### 01. 기본 가정
- **독립성** : 각 집단의 관측치들은 모두 다른 집단의 관측치들과 독립적 (기본 가정)

- **정규성** : 각 집단에서의 관측치는 정규 분포를 따름 (Shapiro-Wilk test)

- **등분산성** : 모든 집단에서의 관측치는 동일한 분산을 가짐 (Levene test)

<br>

### 02. 귀무가설과 대립가설
- 이원 분산 분석은 주 효과뿐만 아니라 상호작용 효과에도 관심을 둠

- 학습 방법과 학습 장소를 요인으로 이원 분산 분석 실시할 경우

  - 효과 2개, 상호작용 효과 1개로 아래와 같이 세가지 가설 가능
 
    - **주 효과** : A 요인 (예: 학습 방법)
   
      - 귀무가설(H₀) : 학습 방법에 따라 성적 차이가 없다
     
      - 대립가설(H₁) : 학습 방법에 따라 성적 차이가 있다
     
    - **주 효과** : B 요인 (예: 학습 장소)
   
      - 귀무가설(H₀) : 학습 방법에 따라 성적 차이가 없다
     
      - 대립가설(H₁) : 학습 방법에 따라 성적 차이가 있다
     
    - **상호작용 효과**
   
      - 귀무가설(H₀) : A 요인과 B 요인 간에 상호작용이 없다
     
      - 대립가설(H₁) : A 요인과 B 요인 간에 상호작용이 있다

<br>

### 03. 이원 분산 분석
- 스태츠모델즈(statsmodels)의 ols 와 anova_lm 사용

> 코드
```python
  model = ols(종송변수 ~ C(요인1) + C(요인2) + C(요인1) : C(요인2)).fit()
  anova_lm(model, typ=숫자)
```
- **종속변수** : 연속형 변수

- **요인1** : 첫 번째 독립변수(범주형 변수)

- **요인2** : 두 번째 독립변수(범주형 변수)

- **typ=1** : 변수의 순서에 따른 분석(기본값)

- **typ=2** : 각 변수의 독립적인 효과 분석

- **typ=3** : 모든 변수와 상호작용을 동시에 고려해 분석

<br>

#### ✏️ 문제
> 데이터는 네 가지 종류의 나무(A, B, C, D)에 대해 세 가지 종류의 비료(1, 2, 3)를 사용해 성장률을 조사한 결과다<br>
> 비료간 및 나무 종류 간의 성장률 차이가 있는지 유의수준 0.05 하에서 검정하시오<br>
> (단, 독립성, 정규성, 등분산성에 만족한 데이터)

- **나무(주 효과)**

  - 귀무가설(H₀) : 모든 나무 종류의 성장률은 동일하다
 
  - 대립가설(H₁) : 나무 종류의 성장률에는 차이가 있다

- **비료(주 효과)**

  - 귀무가설(H₀) : 모든 비료의 성장률 효과는 동일하다
 
  - 대립가설(H₁) : 비료의 성장률 효과에는 차이가 있다

 - **상호작용 효과**

  - 귀무가설(H₀) : 나무 종류와 비료 간의 상호작용은 성장률에 영향을 주지 않는다
 
  - 대립가설(H₁) : 나무 종류와 비료 간에는 성장률에 영향을 주는 상호작용이 있다

<br>

> 코드
```python
  import pandas as pd
  df = pd.read_csv('./data/tree.csv')
  print(df.sample(10))
```
- 데이터가 순서대로 되어 있어 sample() 함수를 활용해 샘플 확인

  - sample() : 랜덤으로 데이터 샘플을 보여줌
 
- 문제에서 이원 분산 분석에 필요한 가정(독립성, 정규성, 등분산성) 만족한다고 명시함

  - 이원 분산 분석에 집중 (statsmodels 활용)

> 결과
```python
      나무  비료  성장률
  36   B   1  57.088636
  68   C   1  63.616360
  52   B   3  54.230780
  59   B   3  70.755451
  90   D   1  65.970775
  108  D   2  70.575504
  116  D   3  70.652882
  94   D   1  61.078918
  115  D   3  74.015473
  60   C   1  55.208258
```

<br>

### 04. ols(종송변수 ~ 요인1 + 요인2 + 요인1 : 요인2).fit()
- ols(최소 제곱 선형 회귀) 모델을 만들고 데이터를 넣어서 학습

  - 성장률이 나무, 비료 그리고 나무와 비료의 상호작용에 어떻게 영향을 받는지 모델링

<br>

#### (1) sm.stats.anova_lm(model)
- sm.stats.anova_lm(model, typ={1, 2, 3}) 으로 ANOVA 테이블 생성

- typ 파라미터는 ANOVA 테이블을 계산하는 방식 결정

  - 기본값은 typ=1
 
  - 문제에서 특별한 계산 방식에 대한 요청이 없다면 기본값 활용
 
  - 모델이 단순하다면 파라미터가 변경되어도 유사한 결과 나타남
 
    - **typ=1** : 순차적 합곱제곱(SS), 변수를 하나씩 추가하면서 그 변수가 결과에 얼마나 영향을 미치는지 순서대로 계산
   
      - ex) sm.stats.anova_lm(model, typ=1)
     
    - **typ=2** : 불순차적 합곱제곱(SS), 각 변수가 모델 전체에 독립적으로 얼마나 영향을 미치는지 확인
   
      - ex) sm.stats.anova_lm(model, typ=2)
     
    - **typ=3** : 타입3 합곱제곱(Type III SS), 변수들 간의 상호작용 고려해 모든 변수가 모델 안에 있는 상태에서 각 변수의 효과 계산
   
      - ex) sm.stats.anova_lm(model, typ=3)

<br>

> 코드
```python
  # 주어진 선형 모델에 대한 ANOVA 테이블 생성
  import statsmodels.api as sm
  from statsmodels.formula.api import ols
  
  model = ols('성장률 ~ 나무 + 비료 + 나무:비료', data=df).fit()
  anova_table = sm.stats.anova_lm(model)
  print(anova_table)
```

> 결과
```python
               df       sum_sq      mean_sq          F        PR(>F)
  나무          3.0  4783.353938  1594.451313  18.391274  9.016693e-10
  비료          1.0   873.322002   873.322002  10.073374  1.942421e-03
  나무:비료     3.0   394.801585   131.600528   1.517952  2.137666e-01
  Residual    112.0  9709.960792    86.696078        NaN           NaN
```
- 비료는 1, 2, 3 숫자로 표현되어있어 연속형 변수로 연속형변수로 오해석 가능성 有

  - 잘못된 해석은 분석 결과에 영향을 줌
 
    - 숫자로 된 범주형 변수 분석시 C() 사용해 명확히 범주형으로 처리
   
      - 모든 변수에 C() 사용하는 것도 방법이나 종속변수는 연속형 변수이므로 제외해야 함

<br>

> 코드
```python
  import statsmodels.api as sm
  from statsmodels.formula.api import ols
  
  model = ols('성장률 ~ C(나무) + C(비료) + C(나무):C(비료)', data=df).fit()
  anova_table = sm.stats.anova_lm(model)
  print(anova_table)
```

> 결과
```python
                  df       sum_sq      mean_sq          F        PR(>F)
  C(나무)          3.0  4783.353938  1594.451313  18.855528  6.600012e-10
  C(비료)          2.0  1127.924259   563.962129   6.669256  1.857612e-03
  C(나무):C(비료)    6.0   717.520672   119.586779   1.414199  2.157357e-01
  Residual     108.0  9132.639448    84.561476        NaN           NaN
```

<br>

#### (2) 나무 종류에 대한 효과
- **df** : 자유도는 3

  - 4개의 나무 종류가 있으므로 4 - 1 = 3 으로 계산
 
- **sum_sq** : 총 제곱합은 4783.353938

- **mean_sq** : 평균 제곱은 1594.451313

- **F** : F-통계량은 18.855528

- **PR(>F)** : p-value(값) 는 6.600012e-10(0.000000000066)

- **결론** : 5% 유의수준에서 p-value < 0.05

  - 나무 종류에 따른 성장률이 유의미한 차이가 있다고 할 수 있음

<br>

#### (3) 비료에 대한 효과
- **df** : 자유도는 2

  - 3개의 비료 종류가 있으므로 3 - 1 = 2 로 계산
 
- **sum_sq** : 총 제곱합은 1127.924259

- **mean_sq** : 평균 제곱은 563.962129 

- **F** : F-통계량은 6.669256

- **PR(>F)** : p-value(값) 는 1.857612e-03(0.001857612)

- **결론** : 5% 유의수준에서 p-value < 0.05

  - 비료 종류에 따른 성장률이 유의미한 차이가 있다고 할 수 있음

<br>

#### (4) 나무와 비료 간의 상호작용 효과
- **df** : 자유도는 6

  - 4(나무 종류) * 3(비료 종류) - 4(나무 종류) - 3(비료 종류)  + 1 = 6
 
- **sum_sq** : 총 제곱합은 717.520672

- **mean_sq** : 평균 제곱은 119.586779 

- **F** : F-통계량은 1.414199

- **PR(>F)** : p-value(값) 는 2.157357e-01(0.2157357)

- **결론** : 5% 유의수준에서 p-value > 0.05

  - 나무 종류와 비료 종류 간의 상호작용은 성장률에 유의미한 영향을주지 않음

<br>

#### (5) 최종 결론
- 나무 종류와 비료 종류는 모두 성장률에 유의미한 영향을 준다

- 나무와 비료 간의 상호작용은 성장률에 유의미한 영향을 주지 않는다

<br>

#### 💡 PR(>F) 값이 지수 표기법으로 출력될 경우
- format() 함수를 활용해 간단하게 확인 가능

  - 숫자를 고정 소수점 표기법으로 변환하되, 소수점 아래를 11자리까지 표시하라는 의미

> 코드
```python
  print(format(6.600012e-10, '.11f'))
  print(format(1.857612e-03, '.11f'))
  print(format(2.157357e-01, '.11f'))
```
- f : 고정 소수점 형식 의미

- .11 : 소수점 아래 숫자를 11자리까지 표시하라는 의미

> 결과
```python
  0.00000000066
  0.00185761200
  0.21573570000
```

<br>

#### 💡 formula 작성법
- '성장률 ~ C(나무) + C(비료) + C(나무) : C(비료)' = '성장률 ~ C(나무) * C(비료)'

  - 성장률을 나무와 비료, 나무와 비료의 상호작용에 따라 예측한다는 의미

> 코드
```python
  model = ols('성장률 ~ C(나무) * C(비료)', data=df).fit()
  anova_table = sm.stats.anova_lm(model)
  print(anova_table)
```

> 결과
```python
                  df       sum_sq      mean_sq          F        PR(>F)
  C(나무)          3.0  4783.353938  1594.451313  18.855528  6.600012e-10
  C(비료)          2.0  1127.924259   563.962129   6.669256  1.857612e-03
  C(나무):C(비료)    6.0   717.520672   119.586779   1.414199  2.157357e-01
  Residual     108.0  9132.639448    84.561476        NaN           NaN
```

<br>

- formula 에러

  - formula 는 변수의 띄어쓰기나 특수 문자를 인식하지 못함
 
    - 변수(컬럼)명에 '나 무' 나 '비료(kg)' 처럼 띄어쓰기나 특수 문자가 있다면 에러 발생
   
      - df.rename(columns={'나 무':'나무', '비료(kg)':'비료'}) 로 컬럼명 변경

<br>

